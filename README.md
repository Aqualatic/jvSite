# JVHub

Static frontend backed by Supabase (Postgres), deployed on Vercel. Song metadata is served from the `media/` directory; ratings and comments are persisted server-side.

---

## Schema

Run in the Supabase SQL editor:

```sql
create table if not exists public.songs (
  id text primary key,
  title text not null,
  audio_url text not null,
  cover_url text not null,
  filename text,
  created_at timestamptz not null default now()
);

create table if not exists public.ratings (
  song_id text primary key,
  likes integer not null default 0,
  dislikes integer not null default 0
);

create table if not exists public.comments (
  id bigint generated by default as identity primary key,
  song_id text not null,
  author text not null,
  body text not null,
  created_at timestamptz not null default now()
);

create index if not exists comments_song_id_created_at_idx
  on public.comments (song_id, created_at desc);
```

### Atomic rating increments

To avoid lost updates under concurrent writes, ratings go through a PL/pgSQL function using `INSERT ... ON CONFLICT DO UPDATE` rather than a read-modify-write cycle:

```sql
create or replace function public.increment_rating(
  p_song_id text,
  p_like_delta integer,
  p_dislike_delta integer
)
returns table (likes integer, dislikes integer)
language plpgsql
as $$
begin
  insert into public.ratings (song_id, likes, dislikes)
  values (p_song_id, greatest(0, p_like_delta), greatest(0, p_dislike_delta))
  on conflict (song_id) do update
    set likes    = greatest(0, public.ratings.likes    + p_like_delta),
        dislikes = greatest(0, public.ratings.dislikes + p_dislike_delta);

  return query
    select r.likes, r.dislikes
    from public.ratings r
    where r.song_id = p_song_id;
end;
$$;
```

---

## Architecture

All Supabase calls go through Vercel serverless functions in `api/` — the service role key is never sent to the client. Rating counts are kept consistent across sessions via short-interval polling rather than a Realtime subscription.

---

## Environment variables

Set the following in **Vercel → Project Settings → Environment Variables**:

| Variable | Notes |
|---|---|
| `SUPABASE_URL` | Project URL from Supabase dashboard |
| `SUPABASE_SERVICE_ROLE_KEY` | Server-only. Do not expose client-side. |

For local dev, copy `.env.example` → `.env.local`. Both are gitignored.

---

## Local development

Requires the Vercel CLI to run `api/` routes locally:

```bash
vercel dev
```

---

## Misc

If you've accidentally committed credentials, rotate the service role key immediately in the Supabase dashboard under **Project Settings → API**.
