# JVHub (Vercel + Supabase)

Static site that lists songs from the `media/` folder and supports **likes/dislikes + comments** stored in Supabase.

## Setup

### 1. Create tables in Supabase

Run this in the Supabase SQL editor:

```sql
create table if not exists public.ratings (
  song_id text primary key,
  likes integer not null default 0,
  dislikes integer not null default 0
);

create table if not exists public.comments (
  id bigint generated by default as identity primary key,
  song_id text not null,
  author text not null,
  body text not null,
  created_at timestamptz not null default now()
);

create index if not exists comments_song_id_created_at_idx
  on public.comments (song_id, created_at desc);
```

## Live updates (likes/dislikes)

Likes/dislikes are **shared** across users, but the UI needs a refresh mechanism to see other users’ clicks.  
This project uses simple **polling** (every few seconds) so counts update for everyone without needing realtime subscriptions.

### 1b. Create atomic rating increment function (recommended)

This makes likes/dislikes **not lose votes** under concurrent traffic:

```sql
create or replace function public.increment_rating(
  p_song_id text,
  p_like_delta integer,
  p_dislike_delta integer
)
returns table (likes integer, dislikes integer)
language plpgsql
as $$
begin
  insert into public.ratings (song_id, likes, dislikes)
  values (
    p_song_id,
    greatest(0, p_like_delta),
    greatest(0, p_dislike_delta)
  )
  on conflict (song_id) do update
    set likes = greatest(0, public.ratings.likes + p_like_delta),
        dislikes = greatest(0, public.ratings.dislikes + p_dislike_delta);

  return query
    select r.likes, r.dislikes
    from public.ratings r
    where r.song_id = p_song_id;
end;
$$;
```

### 2. Configure environment variables

This project reads Supabase via Vercel serverless functions (so secrets never go to the browser).

Set these in Vercel: **Project Settings → Environment Variables**:

- `SUPABASE_URL`
- `SUPABASE_SERVICE_ROLE_KEY` (server-only, never expose)

For local development, copy `.env.example` to `.env.local` and fill them in.

## Local development

To run the site locally with the `api/` endpoints, use the Vercel CLI:

```bash
vercel dev
```

## Notes

- `.env` / `.env.local` are ignored by git (and should not be committed).
- If you ever accidentally committed real Supabase secrets, rotate them in the Supabase dashboard.