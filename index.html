<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>JVHub</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        
        *{box-sizing:border-box;margin:0;padding:0}
        body{font-family:'Press Start 2P', cursive;background:#000;color:#fff}
        header{background:#000;color:#fff;padding:18px;text-align:center}
        nav{background:#444;padding:8px 16px}
        nav a{color:#fff;margin-right:12px;text-decoration:none}
        .container{max-width:1100px;margin:20px auto;padding:0 16px}
        .listings{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:18px}
        .listing{background:#111;border:1px solid #333;padding:12px;position:relative;overflow:hidden}
        .listing h3{font-size:11px;color:#fff;margin-bottom:6px}

        /* media box + overlay */
        .media{position:relative;width:100%;height:0;padding-bottom:56.25%;background:#000;margin:10px 0}
        .media img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;display:block}
        .overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.35)}
        .play-btn{width:64px;height:64px;border-radius:50%;background:rgba(255,255,255,0.9);border:none;display:grid;place-items:center;cursor:pointer;transition:background .2s}
        .play-btn svg{width:28px;height:28px;fill:#111}
        .listing.playing .play-btn{background:#111}
        .listing.playing .play-btn svg{fill:#fff}
        audio{display:none}

        /* rating */
        .rating{display:flex;align-items:center;gap:15px;margin-top:10px}
        .rating-btn{background:none;border:2px solid transparent;border-radius:6px;cursor:pointer;display:flex;align-items:center;gap:6px;font-family:'Press Start 2P',cursive;font-size:10px;padding:4px 8px;transition:border-color .15s,background .15s}
        .rating-btn.like{color:#4CAF50}
        .rating-btn.like.active{border-color:#4CAF50;background:rgba(76,175,80,0.15)}
        .rating-btn.dislike{color:#f44336}
        .rating-btn.dislike.active{border-color:#f44336;background:rgba(244,67,54,0.15)}
        .rating-count{font-size:10px}

        /* comments */
        .comments-section{margin-top:14px;border-top:1px solid #333;padding-top:12px}
        .comments-title{font-size:9px;color:#aaa;margin-bottom:10px}
        .comment-form{display:flex;flex-direction:column;gap:6px;margin-bottom:12px}
        .comment-form input,
        .comment-form textarea{background:#1a1a1a;border:1px solid #444;color:#fff;font-family:'Press Start 2P',cursive;font-size:8px;padding:8px;border-radius:4px;resize:none;outline:none;transition:border-color .2s}
        .comment-form input:focus,
        .comment-form textarea:focus{border-color:#666}
        .comment-form textarea{min-height:60px}
        .comment-submit{background:#333;border:1px solid #555;color:#fff;font-family:'Press Start 2P',cursive;font-size:8px;padding:8px;cursor:pointer;border-radius:4px;transition:background .2s}
        .comment-submit:hover{background:#444}
        .comment-submit:disabled{opacity:.5;cursor:not-allowed}
        .comments-list{display:flex;flex-direction:column;gap:8px;max-height:220px;overflow-y:auto}
        .comments-list::-webkit-scrollbar{width:4px}
        .comments-list::-webkit-scrollbar-track{background:#1a1a1a}
        .comments-list::-webkit-scrollbar-thumb{background:#444;border-radius:2px}
        .comment-item{background:#1a1a1a;border:1px solid #2a2a2a;border-radius:4px;padding:8px}
        .comment-author{font-size:8px;color:orange;margin-bottom:4px}
        .comment-body{font-size:7px;color:#ccc;line-height:1.6;word-break:break-word}
        .comment-time{font-size:6px;color:#555;margin-top:4px}
        .comment-empty{font-size:7px;color:#555;text-align:center;padding:10px 0}
        .loading-msg{font-size:7px;color:#555;text-align:center;padding:6px 0}
    </style>
</head>
<body>
    <header>
        <h1><span style="color:white;font-weight:bold">JV</span><span style="color:orange;font-weight:bold">Hub</span></h1>
        <p style="opacity:.85">Leave now, and save your ears</p>
    </header>
    <main class="container">
        <h2 id="singles" style="margin-top:40px;margin-bottom:30px;">Recent Singles</h2>
        <div class="listings">

            <!-- SONG: alliwant -->
            <div class="listing" data-song="alliwant" data-src="media/alliwant.mp3">
                <h3>All I Want For Christmas Is You - Cover</h3>
                <div class="media">
                    <img src="media/alliwant.png" alt="Album Cover">
                    <div class="overlay"><button class="play-btn" aria-label="Play"><svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg></button></div>
                </div>
                <audio src="media/alliwant.mp3"></audio>
                <div class="rating">
                    <button class="rating-btn like" data-type="like"><span>üëç</span><span class="rating-count">‚Äî</span></button>
                    <button class="rating-btn dislike" data-type="dislike"><span>üëé</span><span class="rating-count">‚Äî</span></button>
                </div>
                <div class="comments-section">
                    <div class="comments-title">COMMENTS</div>
                    <div class="comment-form">
                        <input type="text" placeholder="Your name" maxlength="30">
                        <textarea placeholder="Leave a comment..."></textarea>
                        <button class="comment-submit">POST</button>
                    </div>
                    <div class="comments-list"><div class="loading-msg">Loading...</div></div>
                </div>
            </div>

            <!-- SONG: diewa -->
            <div class="listing" data-song="diewa" data-src="media/diewa.mp3">
                <h3>Die with a Smile - The Cover</h3>
                <div class="media">
                    <img src="media/dwa.png" alt="Album Cover">
                    <div class="overlay"><button class="play-btn" aria-label="Play"><svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg></button></div>
                </div>
                <audio src="media/diewa.mp3"></audio>
                <div class="rating">
                    <button class="rating-btn like" data-type="like"><span>üëç</span><span class="rating-count">‚Äî</span></button>
                    <button class="rating-btn dislike" data-type="dislike"><span>üëé</span><span class="rating-count">‚Äî</span></button>
                </div>
                <div class="comments-section">
                    <div class="comments-title">COMMENTS</div>
                    <div class="comment-form">
                        <input type="text" placeholder="Your name" maxlength="30">
                        <textarea placeholder="Leave a comment..."></textarea>
                        <button class="comment-submit">POST</button>
                    </div>
                    <div class="comments-list"><div class="loading-msg">Loading...</div></div>
                </div>
            </div>

            <!-- SONG: trt -->
            <div class="listing" data-song="trt" data-src="media/trt.mp3">
                <h3>Temu Rose Toy - KLICKAUD</h3>
                <div class="media">
                    <img src="media/trt.png" alt="Album Cover">
                    <div class="overlay"><button class="play-btn" aria-label="Play"><svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg></button></div>
                </div>
                <audio src="media/trt.mp3"></audio>
                <div class="rating">
                    <button class="rating-btn like" data-type="like"><span>üëç</span><span class="rating-count">‚Äî</span></button>
                    <button class="rating-btn dislike" data-type="dislike"><span>üëé</span><span class="rating-count">‚Äî</span></button>
                </div>
                <div class="comments-section">
                    <div class="comments-title">COMMENTS</div>
                    <div class="comment-form">
                        <input type="text" placeholder="Your name" maxlength="30">
                        <textarea placeholder="Leave a comment..."></textarea>
                        <button class="comment-submit">POST</button>
                    </div>
                    <div class="comments-list"><div class="loading-msg">Loading...</div></div>
                </div>
            </div>

            <!-- SONG: trtp -->
            <div class="listing" data-song="trtp" data-src="media/trtp.mp3">
                <h3>Temu Rose Toy - Performative Remix</h3>
                <div class="media">
                    <img src="media/per.png" alt="Album Cover">
                    <div class="overlay"><button class="play-btn" aria-label="Play"><svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg></button></div>
                </div>
                <audio src="media/trtp.mp3"></audio>
                <div class="rating">
                    <button class="rating-btn like" data-type="like"><span>üëç</span><span class="rating-count">‚Äî</span></button>
                    <button class="rating-btn dislike" data-type="dislike"><span>üëé</span><span class="rating-count">‚Äî</span></button>
                </div>
                <div class="comments-section">
                    <div class="comments-title">COMMENTS</div>
                    <div class="comment-form">
                        <input type="text" placeholder="Your name" maxlength="30">
                        <textarea placeholder="Leave a comment..."></textarea>
                        <button class="comment-submit">POST</button>
                    </div>
                    <div class="comments-list"><div class="loading-msg">Loading...</div></div>
                </div>
            </div>

        </div>
    </main>

    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
    // ---- Audio player (runs immediately, no credentials needed) ----
    (function(){
        let current = null;
        document.querySelectorAll('.listing').forEach(listing => {
            const btn   = listing.querySelector('.play-btn');
            const audio = listing.querySelector('audio');
            if (!audio.src) audio.src = listing.dataset.src || '';
            btn.addEventListener('click', e => {
                e.stopPropagation();
                if (current && current !== audio) {
                    current.pause();
                    const prevListing = current.closest('.listing');
                    prevListing?.classList.remove('playing');
                    const prevBtn = prevListing?.querySelector('.play-btn');
                    if (prevBtn) prevBtn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>';
                }
                if (audio.paused) {
                    audio.play().catch(()=>{});
                    listing.classList.add('playing');
                    btn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>';
                    current = audio;
                } else {
                    audio.pause();
                    listing.classList.remove('playing');
                    btn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>';
                    current = null;
                }
            });
            audio.addEventListener('ended', () => {
                listing.classList.remove('playing');
                btn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>';
                if (current === audio) current = null;
            });
        });
    })();

    // ---- Helpers ----
    function timeAgo(ts) {
        const diff = Math.floor((Date.now() - new Date(ts)) / 1000);
        if (diff < 60)    return `${diff}s ago`;
        if (diff < 3600)  return `${Math.floor(diff / 60)}m ago`;
        if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;
        return `${Math.floor(diff / 86400)}d ago`;
    }

    function escapeHtml(str) {
        return String(str)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;');
    }

    function renderComments(list, comments) {
        if (!comments || comments.length === 0) {
            list.innerHTML = '<div class="comment-empty">No comments yet. Be first!</div>';
            return;
        }
        list.innerHTML = comments.map(c => `
            <div class="comment-item">
                <div class="comment-author">${escapeHtml(c.author)}</div>
                <div class="comment-body">${escapeHtml(c.body)}</div>
                <div class="comment-time">${timeAgo(c.created_at)}</div>
            </div>
        `).join('');
    }

    // ---- Main init ‚Äî fetches credentials then wires up all listings ----
    async function init() {
        // Fetch keys from our serverless function (never exposed in source)
        const { supabase_url, supabase_anon } = await fetch('/api/config').then(r => r.json());
        const sb = supabase.createClient(supabase_url, supabase_anon);

        document.querySelectorAll('.listing').forEach(listing => {
            const songId       = listing.dataset.song;
            const likeBtn      = listing.querySelector('.rating-btn.like');
            const dislikeBtn   = listing.querySelector('.rating-btn.dislike');
            const likeCount    = likeBtn.querySelector('.rating-count');
            const dislikeCount = dislikeBtn.querySelector('.rating-count');
            const commentsList = listing.querySelector('.comments-list');
            const nameInput    = listing.querySelector('.comment-form input');
            const bodyInput    = listing.querySelector('.comment-form textarea');
            const submitBtn    = listing.querySelector('.comment-submit');

            let myVote = null;

            async function loadRatings() {
                const { data } = await sb
                    .from('ratings')
                    .select('likes, dislikes')
                    .eq('song_id', songId)
                    .single();
                likeCount.textContent    = data ? data.likes    : 0;
                dislikeCount.textContent = data ? data.dislikes : 0;
            }

            async function loadComments() {
                const { data } = await sb
                    .from('comments')
                    .select('author, body, created_at')
                    .eq('song_id', songId)
                    .order('created_at', { ascending: false });
                renderComments(commentsList, data);
            }

            [likeBtn, dislikeBtn].forEach(btn => {
                btn.addEventListener('click', async () => {
                    const type = btn.dataset.type;
                    let likeDelta = 0, dislikeDelta = 0;

                    if (myVote === type) {
                        if (type === 'like')    likeDelta    = -1;
                        if (type === 'dislike') dislikeDelta = -1;
                        btn.classList.remove('active');
                        myVote = null;
                    } else {
                        if (myVote === 'like')    { likeDelta    = -1; likeBtn.classList.remove('active'); }
                        if (myVote === 'dislike') { dislikeDelta = -1; dislikeBtn.classList.remove('active'); }
                        if (type === 'like')    likeDelta    += 1;
                        if (type === 'dislike') dislikeDelta += 1;
                        btn.classList.add('active');
                        myVote = type;
                    }

                    likeCount.textContent    = parseInt(likeCount.textContent)    + likeDelta;
                    dislikeCount.textContent = parseInt(dislikeCount.textContent) + dislikeDelta;

                    const { data: existing } = await sb
                        .from('ratings')
                        .select('likes, dislikes')
                        .eq('song_id', songId)
                        .single();

                    await sb.from('ratings').upsert({
                        song_id:  songId,
                        likes:    Math.max(0, (existing?.likes    || 0) + likeDelta),
                        dislikes: Math.max(0, (existing?.dislikes || 0) + dislikeDelta)
                    }, { onConflict: 'song_id' });
                });
            });

            submitBtn.addEventListener('click', async () => {
                const author = nameInput.value.trim();
                const body   = bodyInput.value.trim();
                if (!author || !body) return;

                submitBtn.disabled    = true;
                submitBtn.textContent = 'POSTING...';

                const { error } = await sb.from('comments').insert({ song_id: songId, author, body });

                if (!error) {
                    nameInput.value = '';
                    bodyInput.value = '';
                    await loadComments();
                }

                submitBtn.disabled    = false;
                submitBtn.textContent = 'POST';
            });

            loadRatings();
            loadComments();
        });
    }

    init();
    </script>
</body>
</html>